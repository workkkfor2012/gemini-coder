# Python WebSocket 后端开发文档 (与浏览器插件通信) - 关键信息

## 1. 引言

### 1.1. 文档目的
本文档概述了用于与特定浏览器插件进行双向通信的 Python WebSocket 服务器的关键设计信息。

### 1.2. 基本功能
*   启动并运行 WebSocket 服务器。
*   管理与浏览器插件的单一连接。
*   通过 JSON 格式接收和发送文本消息。

### 1.3. 运行环境与假设
*   **单一连接**: 系统仅处理一个后端与一个插件实例的连接。
*   **单一目标页面**: 插件仅与一个目标网页交互。
*   **顺序消息**: 消息按顺序处理，无需队列或并发控制。
*   **Python 环境**: 假设 Python 3.x 及 `websockets` 库可用。

## 2. WebSocket 服务器实现要点

*   **库**: 使用 Python 的 `websockets` 库。
*   **连接管理**:
    *   维护一个全局变量来存储当前连接的插件 WebSocket 客户端实例。
    *   `connection_handler`: 处理新的连接请求。由于假设单一连接，后续连接尝试应被拒绝或替换现有连接。存储成功连接的客户端实例到全局变量。处理连接断开并清理全局变量。
*   **消息处理**:
    *   `handle_message`: 负责处理从插件接收到的消息。
        *   解析传入的 JSON 消息。
        *   提取 `"text"` 字段的内容。
        *   **在此处实现处理接收到文本的核心业务逻辑。**
*   **消息发送**:
    *   `send_to_plugin`: 提供一个函数，用于将文本消息封装成 JSON (`{"text": "..."}`) 并通过存储在全局变量中的客户端实例发送给插件。需要处理发送时可能发生的连接已关闭等异常。
*   **服务器启动**:
    *   使用 `websockets.serve` 启动服务器，绑定到指定的主机和端口 (例如 `localhost:55155`)。
    *   使用 `asyncio.Future()` 或类似机制保持服务器持续运行。
*   **日志**: 建议添加适当的日志记录，用于跟踪连接状态和消息流。

## 3. 通信协议

*   **消息格式**: 统一使用 JSON 格式。
    ```json
    {
      "text": "这里是实际的文本内容"
    }
    ```
*   **插件 -> 服务器**: 插件发送此格式的 JSON，包含需要传递给后端的文本。
*   **服务器 -> 插件**: 后端发送此格式的 JSON。插件端的接收逻辑需要相应调整：解析 JSON，提取 `"text"` 字段的值，然后将该文本内容注入到目标网页（例如 Gemini）的聊天输入框中。

## 4. 运行与测试

1.  **运行**: 执行包含服务器实现的 Python 脚本。
2.  **配置插件**:
    *   **关键**: 修改浏览器插件的源代码（通常在后台脚本 `websocket.ts` 或类似文件中），将 WebSocket 服务器的地址和端口配置为服务器运行时监听的地址（例如，默认是 `ws://localhost:55155`）。插件需要使用此地址来建立连接。
    *   确保插件发送和接收消息时都使用 `{"text": "..."}` 的 JSON 格式。
3.  **测试**:
    *   验证插件与服务器的连接。
    *   测试双向文本消息的发送和接收。
    *   验证服务器 `handle_message` 中的业务逻辑是否符合预期，以及插件在接收到消息后是否能正确地将文本注入目标页面。